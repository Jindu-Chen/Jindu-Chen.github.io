---
title: 嵌入式单片机移植CmBacktrace
date: 2024-01-01
tags:
categories:
- [嵌入式]
- [MCU]
description: CmBacktrace是针对Cortex-M内核芯片提供程序运行异常时的堆栈回溯工具/中间件，将其移植到单片机中，可以在程序异常时打印相应的故障信息包括函数调用链、变量值、寄存器值等，大大缩短bug排查时间。本文介绍CmBacktrace的移植适配过程、原理解析、实际应用以及一些扩展问题思考等。
---


## 前言


## 移植适配与应用

**将相关源码加入工程**

**适配信息打印接口，如串口**

注释掉原有的HardFault中断服务函数

链接脚本中也要增加适配其宏定义（如果没有的话），如栈的起始结束地址、代码段的起始结束地址等

**调用其初始化接口**

Demo应用

addrline2工具解析栈帧

## 原理解析

要理清CmBacktrace的实现原理，首先要了解`ARM Cortex-M`内核的堆栈布局与管理、以及该内核对异常的处理流程。

而CmBacktrace即是根据C语言的栈帧结构、以及Cortex-M内核的工作/异常处理的原理，当触发异常时，对堆栈进行解析实现回溯，而后将信息输出至终端，如串口。

### 堆栈布局与管理

### 异常处理与上下文保存

### CmBacktrace的工作原理


## 注意点与扩展思考

### 其它如Cortex-A内核如何回溯的？

### RTOS下移植CmBacktrace有何不同？

### 程序崩溃跳转至HardFault状态了，为何还能正常控制外设如DMA-UART打印故障信息？

## 参考站点



