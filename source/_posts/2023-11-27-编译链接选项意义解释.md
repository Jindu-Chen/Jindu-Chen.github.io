---
title: 常用编译/链接选项解释
date: 2023-11-22
updated: 2023-11-27
tags:
- [gcc]
- [链接]
- [编译]
- [make]
categories:
- [C语言]
- [嵌入式]
description: 主要介绍GCC+Make开发环境下, 使用arm-none-eabi-工具链进行编译链接, 可选的编译\链接选项, 及其意义解释
---

# GCC编译选项CFLAGS参数及说明

- **`-ffunction-sections`** : 告知编译器将每个函数放置在单独的小节中。在链接过程中只保留实际使用到的函数，未用到的函数将不会被链接，大大缩减生成可执行文件的大小

- **`-fdata-sections`** : 告知编译器将全局和静态变量放置在单独的小节中。与-ffunction-sections类似

- **`--specs=rdimon.specs`** : 

- **`-std=gnu99 -mabi=aapcs`** : 指定使用C语言的GNU 99标准，-mabi=aapcs指定使用ARM架构的AAPCS（ARM Architecture Procedure Call Standard）ABI。


# GCC链接选项LDFLAGS参数及说明

- **`--specs=nosys.specs`** : 禁用标准库的系统调用，在嵌入式程序中应用。
    >当编译时提示：`undefined reference to _sbrk' 或 undefined reference to _write'd` 等等时，可以加上此条选项

- **`--specs=nano.specs`** : 不使用C语言标准库，改用微库，大大减小可执行文件大小。效果类似于应用newlib
    >注意：使用微库后，不支持浮点数格式化标准输出

- **`-Wl,--gc-sections`** : 告知链接器删除未使用的代码和数据段


# 编译纠错修改

- 当编译提示:`- undefined reference to _init`，类似时，检查是否添加了编译选项`--nostdlib`，不链接标准库，却又没指定库，导致的编译错误

- 提示`- exit.c:(.text.exit+0x2c): undefined reference to _exit`，考虑在.ld链接文件的.text段的末尾加上`_exit = .;`

# Makefile应用实例


```
# 指定交叉编译工具链的 编译器、连接器、库管理器、
CROSS_COMPILE=arm-none-eabi-
CC=$(CROSS_COMPILE)gcc
LD=$(CROSS_COMPILE)ld
AR=$(CROSS_COMPILE)ar
AS=$(CROSS_COMPILE)as
OC=$(CROSS_COMPILE)objcopy
OD=$(CROSS_COMPILE)objdump
SZ=$(CROSS_COMPILE)size

# 指定目标硬件的架构和浮点运算单元   -mfpu=fpv4-sp-d16 -mfloat-abi=hard 
# O0:禁用优化，O1：基本优化，O2, O3, Os
# g0:禁用调试信息, g1, g2, g3, g
MCU = -mcpu=cortex-m4 -mthumb \
	-ffunction-sections \
	-fdata-sections \
	-Os -ggdb

# 定义编译C源文件的编译选项：禁用共享变量、函数和数据分段、优化级别、调试信息级别、开启所有警告、目标架构、预定义宏
CFLAGS= -c -fno-common \
	--specs=rdimon.specs \
	-std=gnu99 -mabi=aapcs \
	-Wall \
	$(MCU) \
	$(C_DEFS)

# 定义链接器脚本、链接选项、目标文件格式转换选项、反汇编等等
LDSCRIPT=n32l40x_flash.ld
LDFLAGS = -Wl,--gc-sections --data-sections -mabi=aapcs $(MCU) -T$(LDSCRIPT) \
	--specs=nosys.specs \
	--specs=nano.specs \
	-x assembler-with-cpp -Wa,-mimplicit-it=thumb
OCFLAGS	= -Obinary
ODFLAGS	= -S
```
