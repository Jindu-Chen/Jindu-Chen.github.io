---
title: 嵌入式开发之命令行调试-Shell全剖析
date: 2024-02-08
tags:
categories:
- [MCU]
- [嵌入式]
description: 日常在嵌入式软件开发中的调试方法包括有在线调试、日志打印、Shell 交互、BackTrace 等，其中 Shell 能够以命令行交互的方式直接访问系统信息或者执行功能函数，是辅助开发的调试利器之一，本文主要记录、总结个人对嵌入式 Shell 的应用、理解及原理分析。
---


## 前言

本人初次接触命令行调试，还是在大学时初学正点原子 STM32 教程，其提供了一个软件组件用于调试：（只要你在串口输入相应的函数名，单片机就能执行相应的函数），当时真的惊为天人，觉得这种调试方法很神奇也很有意思。

当时我不了解什么是命令行，什么是Shell，也没有能力或者精力去了解其原理实现，即使那软件组件并不具备一个 Shell 的完整功能，但也足以震惊初学STM32点灯的我

随着开发经历多起来，日常Linux Shell、PowerShell、嵌入式Shell 等等各种什么 Shell 的字眼充斥耳边，本人也对 Shell 这个词有了新的理解，因此也就写下这篇文章，主要为总结和升华个人对嵌入式 Shell 的应用及理解，当然也包括其它的一些方面，或者说在研读源码过程中，能够学习到一些编程方式/方法/思想，那就更好不过了


## 命令行概述

官方百科：Shell，即命令行解释器，是计算机操作系统的一种用户界面，用户可以通过Shell与操作系统进行交互，输入命令来执行各种操作、控制系统的各种功能。Bash、Windows CMD、PowerShell等都是属于命令行解释器

那么嵌入式Shell也是同理，只不过用户是使用上位机串口软件输入命令与嵌入式设备进行交互而已（通常是通过UART串口与外界交互，但其实也可以将输入输出流设置到其它外设上，如蓝牙BLE透传、TCP/IP等）

比如在Linux Shell中，用户在命令行界面输入如`ls cd touch gcc make`等这些命令，使得Shell解释器会调用相对应名称的可执行程序，当然了通常输入命令还会附带参数，这就跟C函数也有入口参数一样。
> 换句话说，命令就是可执行程序，其就是一个被封装好的功能函数。

<br>

另外，命令行能够直接调用这些可执行程序，是因为它们的绝对路径被声明到环境变量路径中了，这样使得Shell解释器能够找到它们
> 所以，不管是在Linux，还是Windows中，环境变量都是个重要概念

<br>

---

下面主要以 Letter-Shell 为例，讲述嵌入式Shell的应用及原理分析


## 引出命令行函数原理

从通俗的角度来说，命令行调用就相当于：用户向设备发送一个指令，这个指令约定好跟一个指定操作有着映射关系，于是设备收到该指令后，去查询并执行其对应映射的操作。



原理大致是将要声明的命令行函数指针变量 声明至一个段中，而后将这个段编译至程序中，程序运行时，可以遍历这个段的函数指针，然后指向这个指针运行即可完成 命令行对这个函数的调用

至于函数名的保存，以及多种变量的调用，则

声明函数段、
在GCC或者Keil环境下的链接脚本要进行不同的配置，声明相关的段不要被编译器优化

### 命令行解析

### 命令函数


### 命令表


## 实时操作系统下获取当前线程运行状态

### 线程栈最大使用率

### CPU空闲率


## Shell 附加功能

### 日志输出

颜色的标准配置

日志等级


### 密码设置原理

## Shell 移植适配（以Letter_Shell为例）



## 注意项及疑惑解答

避免串口回环，导致函数陷入死循环

换行，tab等 标准功能 参照Shell
串口软件之按键键值映射，参照SecureCRT

多端输出

## 参考站点

- [letter shell 3.x](https://github.com/NevermindZZT/letter-shell/blob/master/README.md)
- [letter-shell | 一个功能强大的嵌入式shell](https://zhuanlan.zhihu.com/p/128960695)



