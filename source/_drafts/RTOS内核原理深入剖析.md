---
title: RTOS内核原理深入剖析
date: 2024-01-03
tags:
categories:
- [MCU]
- [RTOS]
description: |
    &emsp;&emsp;刚毕业那会，研究了一段时间的RT-Thread内核原理，自以为对RTOS已经有深入的理解，感觉所有的实时操作系统皆不过如此。<br>
    &emsp;&emsp;回想起来，当时只是着眼于Cortex-M内核如何切换上下文、线程/任务的调度、汇编源码实现等原理这一小方面，而忽视了很多其它值得学习的部分，包括线程调度的代码/算法设计、软件定时器、信号量、命令行调试控制台等核心组件的实现，另外也没有真正动手去做全新的系统移植工作。<br>
    &emsp;&emsp;转眼已过去一年多，对于RTOS的很多原理细节遗忘不少，此外也没有对其进行过系统总结；因此，本文主要以个人的角度，阐述对RTOS内核原理的理解，也包括其扩展部分，如系统移植、核心组件、部件扩展、代码设计等方面。
---

## 摘要

&emsp;&emsp;刚毕业那会，研究了一段时间的RT-Thread内核原理，自以为对RTOS已经有深入的理解，感觉所有的实时操作系统皆不过如此。<br>
&emsp;&emsp;回想起来，当时只是着眼于**Cortex-M内核如何切换上下文、线程/任务的调度**、汇编源码实现等原理这一小方面，而忽视了很多其它值得学习的部分，包括**线程调度的代码/算法设计**、软件定时器、信号量、命令行调试控制台等核心组件的实现，另外也没有真正动手去做全新的系统移植工作。<br>
&emsp;&emsp;转眼已过去一年多，对于RTOS的很多原理细节遗忘不少，此外也没有对其进行过系统总结；因此，本文主要以个人的角度，阐述对RTOS内核原理的理解，也包括其扩展部分，如系统移植、核心组件、部件扩展、代码设计等方面。


## 概述

以rt-thread为例
- 核心：任务调度器的调度原理，如何切换上下文
- 内核组件：系统时基、信号量、互斥量、消息队列、命令行调试、软件定时器
- 移植步骤

- 设备框架深入剖析

## 实时操作系统解析

### 线程/任务 如何调度或者切换

每个线程都必须要有自己私有的栈，并且都要有自己的句柄，用于记录自身的使用信息

堆栈指针 MSP 和 PSP 是必须的 （只用 MSP 是否可行？）

所应用到的异常如 PendSV SVC

对于Cortex-M内核来说，

### 系统任务调度器的调度逻辑

如何查找当前最高优先级

Systick每次中断时，系统调度器会做什么工作？

任务主动阻塞或者主动让出控制权时，系统调度器如何做？

如何判别任务的 多种状态，如阻塞态、就绪态等等

### 内核组件之软件定时器实现

本质上是新建一个专门的高优先级线程用于实现轮询超时时间

所以软件定时器的回调函数不能有延时操作，不然会导致其它已经超时到达的定时器回调函数无法及时响应

### 内核组件之信号量

### 内核组件之互斥量

### 内核组件之消息队列

阻塞等待、延时等待时 是如何影响到系统调度器的


### 内核组件之事件



## 移植思路

- CPU架构层API适配
- 下层API适配
- 上层接口调用

## 注意项及常见疑惑解答



## 参考站点

- [RT-Thread文档中心](https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/README)



